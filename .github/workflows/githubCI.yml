name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1       # Ø¹Ø¯Ù„ÙŠ Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø±ÙŠØ¬ÙˆÙ† Ø¨ØªØ§Ø¹Ùƒ
      TERRAFORM_DIR: ./terraform
      HELM_CHART_DIR: ./helm
      KUBECONFIG: tmp/kubeconfig

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2ï¸âƒ£ Install AWS CLI
    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
        aws --version

    # 3ï¸âƒ£ Install kubectl
    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client

    # 4ï¸âƒ£ Install Helm
    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm version

    # 5ï¸âƒ£ Configure AWS credentials
    - name: Configure AWS credentials
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set region $AWS_REGION

    # 6ï¸âƒ£ Setup Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.14.3 
      with:
        terraform_wrapper: false

    # 7ï¸âƒ£ Terraform Init
    - name: Terraform Init
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: terraform init

    # 8ï¸âƒ£ Terraform Apply
    - name: Terraform Apply
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: terraform apply -auto-approve

    # 9ï¸âƒ£ Get ECR Repository URL and set env variable
    - name: Set ECR repo URL for Helm
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: |
      ECR_REPO=$(terraform output -raw repository_url | tr -d '\n')
      echo "ECR_REPO=$ECR_REPO" >> $GITHUB_ENV


    # ðŸ”Ÿ Deploy Helm chart
    - name: Deploy Helm chart
      run: |
        helm upgrade --install my-app ${{ env.HELM_CHART_DIR }} \
          --set image.repository=$ECR_REPO \
          --set image.tag=latest
