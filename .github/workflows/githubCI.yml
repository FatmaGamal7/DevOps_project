name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      TERRAFORM_DIR: ./terraform
      HELM_CHART_DIR: ./helm

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Configure AWS Credentials (IMPORTANT: before any aws command)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 3Ô∏è‚É£ Install AWS CLI (usually already exists, but safe)
    - name: Install AWS CLI
      run: |
        aws --version

    # 4Ô∏è‚É£ Install kubectl
    - name: Install kubectl
      run: |
        K8S_VERSION=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt | tr -d '\n')
        curl -LO https://storage.googleapis.com/kubernetes-release/release/${K8S_VERSION}/bin/linux/amd64/kubectl
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client

    # 5Ô∏è‚É£ Install Helm
    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm version

    # 6Ô∏è‚É£ Setup Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.7
        terraform_wrapper: false

    # 7Ô∏è‚É£ Terraform Init
    - name: Terraform Init
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: terraform init -input=false

    # 8Ô∏è‚É£ Terraform Apply
    - name: Terraform Apply
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: terraform apply -auto-approve

    # 9Ô∏è‚É£ Get ECR Repository URL from Terraform output
    - name: Set ECR repo URL
      working-directory: ${{ env.TERRAFORM_DIR }}
      run: |
        ECR_REPO=$(terraform output -raw repository_url | tr -d '\n')
        echo "ECR_REPO=$ECR_REPO" >> $GITHUB_ENV
        echo "Using ECR Repo: $ECR_REPO"

    # üîü Update kubeconfig for EKS
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region $AWS_REGION \
          --name ${{ secrets.EKS_CLUSTER_NAME }}
        kubectl get nodes

    # 1Ô∏è‚É£1Ô∏è‚É£ Deploy application using Helm
    - name: Deploy Helm chart
      run: |
        helm upgrade --install my-app ${{ env.HELM_CHART_DIR }} \
          --set image.repository=$ECR_REPO \
          --set image.tag=latest




# ######################################
# name: CI-CD Terraform & Kubernetes

# on:
#   workflow_dispatch:
#     inputs:
#       env:
#         description: 'Environment'
#         required: true
#         default: 'prod'
#         type: choice
#         options:
#           - nonprod
#           - prod
#       destroy:
#         description: 'Destroy resources?'
#         required: true
#         default: false
#         type: boolean

# env:
#   TF_DIR: terraform
#   AWS_REGION: eu-west-1

# jobs:

#   deploy:
#     if: ${{ github.event.inputs.destroy == 'false' }}
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       # ‚úÖ Configure AWS once globally
#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Install Terraform
#         uses: hashicorp/setup-terraform@v2
#         with:
#          terraform_wrapper: false
#       - name: Install kubectl
#         uses: azure/setup-kubectl@v3

#       - name: Install Helm
#         uses: azure/setup-helm@v3

#       # =========================
#       # Terraform Plan + Apply
#       # =========================
#       - name: Terraform Init
#         run: |
#           cd $TF_DIR
#           terraform init -input=false

#       - name: Terraform Workspace
#         run: |
#           cd $TF_DIR
#           terraform workspace select ${{ github.event.inputs.env }} || \
#           terraform workspace new ${{ github.event.inputs.env }}

#       - name: Terraform Apply
#         run: |
#           cd $TF_DIR
#           terraform apply \
#             -var-file="${{ github.event.inputs.env }}.tfvars" \
#             -auto-approve

#       # =========================
#       # Kubernetes Config
#       # =========================
#       - name: Configure kubeconfig
#         run: |
#           set -euo pipefail
#           cd $TF_DIR

#           terraform init -input=false
#           terraform workspace select ${{ github.event.inputs.env }}

#           CLUSTER_NAME=$(terraform output -raw cluster_name | tr -d '\n' | xargs)


#           echo "Cluster name is: $CLUSTER_NAME"

#           aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$AWS_REGION"
#           kubectl get nodes


#       # =========================
#       # Install Ingress
#       # =========================
#       - name: Install Ingress Nginx
#         run: |
#           helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
#           helm repo update
#           helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
#             --namespace ingress-nginx \
#             --create-namespace \
#             --set controller.service.type=LoadBalancer \
#             --wait --timeout 5m

#       # =========================
#       # Build & Push Docker
#       # =========================
#       - name: Build & Push Docker Image
#         run: |
#           cd $TF_DIR
#           ECR_URL=$(terraform output -raw ecr_repository_url)
#           cd ..

#           IMAGE_TAG=${GITHUB_RUN_ID}
#           ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

#           aws ecr get-login-password --region $AWS_REGION | \
#           docker login --username AWS --password-stdin \
#           $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

#           docker build -t app:$IMAGE_TAG app
#           docker tag app:$IMAGE_TAG $ECR_URL:$IMAGE_TAG
#           docker push $ECR_URL:$IMAGE_TAG

#       # =========================
#       # Helm Deploy App
#       # =========================
#       - name: Deploy App via Helm
#         run: |
#           cd $TF_DIR
#           ECR_URL=$(terraform output -raw ecr_repository_url)
#           CLUSTER_NAME=$(terraform output -raw cluster_name)
#           cd ..

#           IMAGE_TAG=${GITHUB_RUN_ID}

#           aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$AWS_REGION"

#           helm upgrade --install auto-dev-demo helm/auto-dev-demo \
#             --namespace demo \
#             --create-namespace \
#             --set image.repository=$ECR_URL \
#             --set image.tag=$IMAGE_TAG \
#             --wait

#           kubectl get pods -n demo
#           kubectl get ingress -n demo


#   destroy:
#     if: ${{ github.event.inputs.destroy == 'true' }}
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Install Terraform
#         uses: hashicorp/setup-terraform@v2

#       - name: Terraform Destroy
#         run: |
#           cd $TF_DIR
#           terraform init -input=false
#           terraform workspace select ${{ github.event.inputs.env }}
#           terraform destroy \
#             -var-file="${{ github.event.inputs.env }}.tfvars" \
#             -auto-approve