trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    displayName: Destroy Infrastructure
    type: boolean
    default: false

variables:
  # Directories
  TF_DIR: terraform
  APP_DIR: hello_app
  HELM_DIR: helm

  # AWS
  AWS_REGION: us-east-1
  AWS_SERVICE_CONNECTION: fatma_aws

  # Image
  IMAGE_TAG: $(Build.BuildId)

########################################
# STAGE 1 – Terraform (Infra + ECR)
########################################
stages:
- stage: Terraform
  displayName: Terraform Infrastructure
  jobs:
  - job: TerraformApply
    pool:
      name: queue-fatma_gamal

    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      name: terraform
      displayName: Terraform Init / Apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e
          cd $(TF_DIR)

          terraform init

          if [ "${{ parameters.destroy }}" = "True" ]; then
            terraform destroy -auto-approve -var-file=${{ parameters.env }}.auto.tfvars
            exit 0
          fi

          terraform apply -auto-approve -var-file=${{ parameters.env }}.auto.tfvars

          # Get ECR repo URL
          ECR_URL=$(terraform output -raw repository_url)
          echo "ECR Repo: $ECR_URL"

          echo "##vso[task.setvariable variable=ECR_URL]$ECR_URL"

########################################
# STAGE 2 – Docker Build & Push to ECR
########################################
- stage: Docker
  displayName: Build & Push Docker Image
  dependsOn: Terraform
  condition: succeeded()

  jobs:
  - job: BuildPush
    pool:
      name: queue-fatma_gamal

    steps:
    - checkout: self

    # (Optional) Docker Hub Login – to avoid rate limit
    - task: Docker@2
      displayName: Docker Hub Login
      inputs:
        command: login
        containerRegistry: docker_hub_connection

    - task: AWSShellScript@1
      displayName: Build & Push Image to ECR
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e

          aws ecr get-login-password --region $(AWS_REGION) \
            | docker login --username AWS --password-stdin $(ECR_URL)

          cd $(APP_DIR)

          docker build -t $(ECR_URL):$(IMAGE_TAG) .
          docker push $(ECR_URL):$(IMAGE_TAG)

          echo "##vso[task.setvariable variable=IMAGE_FULL]$(ECR_URL):$(IMAGE_TAG)"

########################################
# STAGE 3 – Helm Deploy to EKS
########################################
- stage: Helm
  displayName: Deploy Application with Helm
  dependsOn: Docker
  condition: succeeded()

  jobs:
  - job: HelmDeploy
    pool:
      name: queue-fatma_gamal

    steps:
    - checkout: self

    - task: HelmInstaller@1
      displayName: Install Helm
      inputs:
        helmVersionToInstall: latest

    - task: AWSShellScript@1
      displayName: Helm Upgrade / Install
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -e

          aws eks update-kubeconfig \
            --region $(AWS_REGION) \
            --name my-eks-cluster

          cd $(HELM_DIR)

          helm upgrade --install hello-app . \
            --set image.repository=$(ECR_URL) \
            --set image.tag=$(IMAGE_TAG)
